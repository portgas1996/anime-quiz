<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üéå –ê–Ω–∏–º–µ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <link rel="stylesheet" href="/style.css">
  <style>
    #posterCanvas {
      max-width: 90%;
      height: auto;
      display: none;
      margin: 10px auto;
    }
    @media (max-width: 600px) {
      #posterCanvas {
        max-width: 80%;
      }
    }
  </style>
</head>
<body>
  <div class="quiz-container" id="quizContainer">
    <div class="question" id="question"></div>
    <div class="options" id="options"></div>
    <div class="result" id="result"></div>
    <button id="nextBtn" style="display: none;">–°–ª–µ–¥—É—é—â–∏–π</button>
    <button id="resetBtn" style="display: none;">–°–±—Ä–æ—Å–∏—Ç—å</button>
  </div>

  <div class="result-container" id="resultContainer" style="display: none;">
    <h2>üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
    <p>–¢—ã –Ω–∞–±—Ä–∞–ª <span id="score"></span> –æ—á–∫–æ–≤.</p>
    <button id="sendResultBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
    <button id="generatePosterBtn">–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å—Ç–µ—Ä</button>
    <canvas id="posterCanvas"></canvas>
  </div>

  <div class="leaderboard-container" id="leaderboardContainer" style="display: none;">
    <h2>üèÜ –õ–∏–¥–µ—Ä—ã</h2>
    <div id="leaderboard">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <script>
    let questions = [];
    let currentQuestion = 0;
    let score = 0;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ questions.json
    fetch('/questions.json')
      .then(response => {
        if (!response.ok) throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å questions.json: ${response.status}`);
        return response.json();
      })
      .then(data => {
        questions = data;
        loadQuestion();
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
        document.getElementById('question').innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤';
      });

    function loadQuestion() {
      if (questions.length === 0) {
        document.getElementById('question').innerText = '–í–æ–ø—Ä–æ—Å—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';
        return;
      }
      const q = questions[currentQuestion];
      document.getElementById('question').innerText = q.question;
      const optionsDiv = document.getElementById('options');
      optionsDiv.innerHTML = '';
      q.options.forEach((option, index) => {
        const optionEl = document.createElement('div');
        optionEl.className = 'option';
        optionEl.innerText = option;
        optionEl.onclick = () => checkAnswer(index);
        optionsDiv.appendChild(optionEl);
      });
      document.getElementById('result').innerText = '';
      document.getElementById('nextBtn').style.display = 'none';
      document.getElementById('resetBtn').style.display = 'none';
    }

    function checkAnswer(selected) {
      const q = questions[currentQuestion];
      const resultDiv = document.getElementById('result');
      if (selected === q.correct) {
        resultDiv.innerText = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
        score++;
      } else {
        resultDiv.innerText = `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${q.options[q.correct]}`;
      }
      document.getElementById('nextBtn').style.display = 'block';
      document.querySelectorAll('.option').forEach(opt => opt.style.pointerEvents = 'none');
    }

    document.getElementById('nextBtn').onclick = () => {
      currentQuestion++;
      if (currentQuestion < questions.length) {
        loadQuestion();
      } else {
        showResult();
      }
    };

    document.getElementById('resetBtn').onclick = () => {
      currentQuestion = 0;
      score = 0;
      document.getElementById('quizContainer').style.display = 'block';
      document.getElementById('resultContainer').style.display = 'none';
      document.getElementById('leaderboardContainer').style.display = 'none';
      loadQuestion();
    };

    document.getElementById('sendResultBtn').onclick = () => {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.sendData(JSON.stringify({ score, total: questions.length }));
      }
    };

    document.getElementById('generatePosterBtn').onclick = () => {
      generatePoster();
    };

    async function generatePoster() {
      const canvas = document.getElementById('posterCanvas');
      const ctx = canvas.getContext('2d');

      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã –ø–æ—Å—Ç–µ—Ä–∞
      canvas.width = 400;
      canvas.height = 600;

      // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞ –ø–æ—Å—Ç–µ—Ä–∞ –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏
      const templateImg = new Image();
      templateImg.crossOrigin = 'anonymous';
      templateImg.src = '/poster_template.png';

      templateImg.onload = async () => {
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —à–∞–±–ª–æ–Ω–∞
        ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = '#000';
        ctx.textAlign = 'center';
        ctx.fillText(`–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${score} –∏–∑ ${questions.length}`, canvas.width / 2, 80);

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const username = window.Telegram?.WebApp?.initDataUnsafe?.user?.username || '–ò–≥—Ä–æ–∫';
        ctx.font = '18px Arial';
        ctx.fillText(`@${username}`, canvas.width / 2, 120);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (window.Telegram?.WebApp?.initDataUnsafe?.user?.photo_url) {
          const avatarImg = new Image();
          avatarImg.crossOrigin = 'anonymous';
          avatarImg.src = window.Telegram.WebApp.initDataUnsafe.user.photo_url;
          avatarImg.onload = () => {
            ctx.beginPath();
            ctx.arc(80, 80, 40, 0, Math.PI * 2); // –ö—Ä—É–≥–ª—ã–π –∞–≤–∞—Ç–∞—Ä
            ctx.clip();
            ctx.drawImage(avatarImg, 40, 40, 80, 80);
            ctx.restore();
            finalizePoster();
          };
          avatarImg.onerror = () => {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä');
            finalizePoster();
          };
        } else {
          finalizePoster();
        }
      };

      templateImg.onerror = () => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–∞ –ø–æ—Å—Ç–µ—Ä–∞');
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#000';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('–®–∞–±–ª–æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', canvas.width / 2, canvas.height / 2);
        finalizePoster();
      };

      function finalizePoster() {
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å—Ç–µ—Ä
        document.getElementById('posterCanvas').style.display = 'block';
        // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingDownloadBtn = document.querySelector('#resultContainer a');
        if (existingDownloadBtn) existingDownloadBtn.remove();
        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const downloadBtn = document.createElement('a');
        downloadBtn.href = canvas.toDataURL('image/png');
        downloadBtn.download = 'anime_quiz_poster.png';
        downloadBtn.innerText = '–°–∫–∞—á–∞—Ç—å –ø–æ—Å—Ç–µ—Ä';
        downloadBtn.style = 'display: block; margin: 10px auto; padding: 10px; background: #1e90ff; color: white; text-decoration: none; border-radius: 5px;';
        document.getElementById('resultContainer').appendChild(downloadBtn);
      }
    }

    function showResult() {
      document.getElementById('quizContainer').style.display = 'none';
      document.getElementById('resultContainer').style.display = 'block';
      document.getElementById('score').innerText = score;
      document.getElementById('resetBtn').style.display = 'block';
    }

    window.onload = () => {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        window.Telegram.WebApp.setViewportHeight(window.innerHeight);
      }
      loadQuestion();
    };
  </script>
</body>
</html>
```
