<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Anime Quiz</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="quiz-container">
    <h1>Anime Quiz</h1>
    <div id="quiz"></div>
    <button id="nextBtn" style="display:none;">Дальше</button>
    <div id="result"></div>
    <div id="leaderboard">
      <h2>Лидеры</h2>
      <table>
        <thead><tr><th>#</th><th>Игрок</th><th>Счёт</th></tr></thead>
        <tbody id="leadersBody"></tbody>
      </table>
    </div>
  </div>

  <canvas id="posterCanvas" width="600" height="900" style="display:none;"></canvas>
  <button id="posterBtn" style="display:none;">Получить постер</button>

  <script src="poster.js"></script>
  <script>
  let QUESTIONS = [];
  let currentQuestion = 0;
  let score = 0;
  let playerName = "Pirate";

  const quizEl = document.getElementById("quiz");
  const nextBtn = document.getElementById("nextBtn");
  const resultEl = document.getElementById("result");

  async function loadQuestions() {
    const res = await fetch("questions.json");
    QUESTIONS = await res.json();
    showQuestion();
  }

  function showQuestion() {
    if (currentQuestion >= QUESTIONS.length) {
      endGame();
      return;
    }
    const q = QUESTIONS[currentQuestion];
    quizEl.innerHTML = `
      <h3>${q.question}</h3>
      <ul>
        ${q.answers.map((a,i)=>`<li><button onclick="checkAnswer(${i})">${a}</button></li>`).join("")}
      </ul>
    `;
  }

  function checkAnswer(i) {
    const q = QUESTIONS[currentQuestion];
    if (i === q.correct) score++;
    currentQuestion++;
    nextBtn.style.display = "inline-block";
  }

  nextBtn.onclick = () => {
    nextBtn.style.display = "none";
    showQuestion();
  };

  async function endGame() {
    quizEl.innerHTML = "";
    resultEl.innerHTML = `Вы набрали ${score} из ${QUESTIONS.length}`;
    nextBtn.style.display = "none";

    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe?.user || {};
    playerName = user.first_name || "Pirate";
    const photo = user.photo_url || null;

    await fetch("https://anime-quiz-backend-2ien.onrender.com", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({name: playerName, score, total: QUESTIONS.length})
    });

    loadLeaders();

    // вызов генерации постера из poster.js
    document.getElementById("posterBtn").style.display = "inline-block";
    generatePoster(playerName, photo, score);
  }

  async function loadLeaders(){
    try {
      const res = await fetch("https://anime-quiz-backend-2ien.onrender.com");
      const leaders = await res.json();
      const body = document.getElementById("leadersBody");
      body.innerHTML = "";
      leaders.forEach((row,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${row.name}</td><td>${row.score}/${row.total}</td>`;
        body.appendChild(tr);
      });
    } catch(e) {
      console.error("Ошибка загрузки лидеров", e);
    }
  }

  loadQuestions();
  loadLeaders();
  </script>
</body>
</html>
