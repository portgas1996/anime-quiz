<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–Ω–∏–º–µ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app">
  <h1>üéå –ê–Ω–∏–º–µ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</h1>

  <div id="game" class="card">
    <div id="question-area"></div>
    <div style="margin-top:12px;">
      <button id="nextBtn" class="btn-main">–°–ª–µ–¥—É—é—â–∏–π</button>
      <button id="restartBtn" class="btn-sec">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
  </div>

  <div id="finishForm" class="card" style="display:none;">
    <h3>üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h3>
    <p>–¢—ã –Ω–∞–±—Ä–∞–ª <span id="finalScore"></span> –æ—á–∫–æ–≤.</p>
    <input type="text" id="playerName" placeholder="–¢–≤–æ–π –Ω–∏–∫">
    <button id="sendScoreBtn" class="btn-main">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>

    <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏/—Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–æ—Å—Ç–µ—Ä–∞ -->
    <div style="margin-top:12px;">
      <button id="posterBtn" class="btn-main" style="display:none;">–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å—Ç–µ—Ä</button>
    </div>
  </div>

  <div id="leaderboard" class="card">
    <h3>üèÜ –õ–∏–¥–µ—Ä—ã</h3>
    <ol id="leadersList"><li>–ó–∞–≥—Ä—É–∑–∫–∞...</li></ol>
  </div>

  <!-- Canvas –¥–ª—è –ø–æ—Å—Ç–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç) -->
  <canvas id="posterCanvas" width="640" height="960" style="display:none; margin-top:12px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.35);"></canvas>
</div>

<script>
let QUESTIONS = [];
let idx=0, score=0, answered=false;

// –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –∏–∑ JSON
async function loadQuestions(){
  try {
    const res = await fetch("questions.json");
    QUESTIONS = await res.json();
    renderQuestion();
  } catch(e) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ questions.json:", e);
    document.getElementById("question-area").innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤.</p>";
  }
}

// –†–µ–Ω–¥–µ—Ä–∏–º –≤–æ–ø—Ä–æ—Å
function renderQuestion(){
  const area=document.getElementById("question-area");
  area.innerHTML="";
  if(idx>=QUESTIONS.length){
    document.getElementById("game").style.display="none";
    document.getElementById("finishForm").style.display="block";
    document.getElementById("finalScore").innerText=`${score}/${QUESTIONS.length}`;
    return;
  }
  const q=QUESTIONS[idx];
  const qt=document.createElement("div");
  qt.className="question-text"; qt.innerText=q.question;
  area.appendChild(qt);
  const opts=document.createElement("div"); opts.className="options";
  q.options.forEach((opt,i)=>{
    const el=document.createElement("div"); el.className="opt"; el.innerText=opt;
    el.onclick=()=>selectOption(i);
    opts.appendChild(el);
  });
  area.appendChild(opts);
  answered=false;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
function selectOption(i){
  if(answered) return; answered=true;
  const q=QUESTIONS[idx];
  const opts=document.querySelectorAll(".opt");
  opts.forEach((el,j)=>{
    if(j===q.correct) el.classList.add("correct");
    if(j===i && i!==q.correct) el.classList.add("wrong");
  });
  if(i===q.correct) score++;
}

// –ö–Ω–æ–ø–∫–∏
document.getElementById("nextBtn").onclick=()=>{ if(answered){ idx++; renderQuestion(); } };
document.getElementById("restartBtn").onclick=()=>{ idx=0; score=0; renderQuestion(); document.getElementById("game").style.display="block"; document.getElementById("finishForm").style.display="none"; };

// ------------------- –õ–ò–î–ï–†–´ -------------------
async function loadLeaders(){
  try{
    const res=await fetch("https://anime-quiz-backend-2ien.onrender.com");
    const data=await res.json();
    const list=document.getElementById("leadersList"); list.innerHTML="";
    if(!Array.isArray(data) || data.length===0){
      list.innerHTML = "<li>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</li>";
      return;
    }
    data.forEach((row,i)=>{
      const li=document.createElement("li");
      li.innerText=`${i+1}. ${row.name} ‚Äî ${row.score}/${row.total}`;
      list.appendChild(li);
    });
  }catch(e){ console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–æ–≤:", e); document.getElementById("leadersList").innerHTML = "<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>"; }
}

async function submitScore(){
  const nameInput = document.getElementById("playerName").value;
  const name = nameInput && nameInput.trim() ? nameInput.trim() : "–ê–Ω–æ–Ω–∏–º";
  try{
    await fetch("https://anime-quiz-backend-2ien.onrender.com",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name,score,total:QUESTIONS.length})
    });
    await loadLeaders();
    alert("–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");

    // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚Äî –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∞–≤–∞—Ç–∞—Ä –∏–∑ Telegram (–µ—Å–ª–∏ –∏–≥—Ä–∞ –≤ WebApp)
    let tgPhoto = null;
    try {
      tgPhoto = window.Telegram?.WebApp?.initDataUnsafe?.user?.photo_url || null;
    } catch(e){ tgPhoto = null; }

    // –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–µ—Ä–∞ (–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è)
    generatePoster(name, tgPhoto, score);
  }catch(e){
    console.error(e);
    alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏");
  }
}

// –ø–æ–≤–µ—Å–∏–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ (—á—Ç–æ–±—ã input —Ä–∞–±–æ—Ç–∞–ª)
document.getElementById("sendScoreBtn").addEventListener("click", submitScore);

// ------------------- POSTER (Canvas) -------------------
// helper: –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (crossOrigin)
function loadImage(src){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.onerror = (err) => reject(err);
    img.src = src;
  });
}

/*
  generatePoster(name, photoUrl, score)
  - name: —Å—Ç—Ä–æ–∫–∞
  - photoUrl: —Å—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É (–∏–ª–∏ null)
  - score: —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
*/
async function generatePoster(name, photoUrl, score){
  const canvas = document.getElementById("posterCanvas");
  const ctx = canvas.getContext("2d");

  // –û—á–∏—Å—Ç–∏–º —Ö–æ–ª—Å—Ç
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // –®–∞–±–ª–æ–Ω –ø–æ—Å—Ç–µ—Ä–∞ (–ø–æ–ª–æ–∂–∏ wanted_template.png —Ä—è–¥–æ–º —Å index.html)
  let bg;
  try {
    bg = await loadImage("wanted_template.png");
  } catch(e){
    console.warn("–®–∞–±–ª–æ–Ω –ø–æ—Å—Ç–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω:", e);
    // –µ—Å–ª–∏ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–∞ - –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–ª–Ω–∏–º —Ñ–æ–Ω
    ctx.fillStyle = "#e9d6b7";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  if(bg) ctx.drawImage(bg,0,0,canvas.width,canvas.height);

  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Ä–∞–∑–º–µ—Ä –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏
  const avatarX = 170;
  const avatarY = 210;
  const avatarSize = 300;
  // –†–∏—Å—É–µ–º –∞–≤–∞—Ç–∞—Ä –≤ –∫—Ä—É–≥–ª–æ–π –º–∞—Å–∫–µ
  try {
    const avatarSrc = photoUrl || "https://i.ibb.co/7n5T8Ns/avatar-placeholder.png";
    const avatarImg = await loadImage(avatarSrc);

    // –û–±—Ä–µ–∑–∞–µ–º / –≤–ø–∏—Å—ã–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä –≤ –∫—Ä—É–≥
    const cx = avatarX + avatarSize/2;
    const cy = avatarY + avatarSize/2;
    const r = avatarSize/2;

    ctx.save();
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.closePath();
    ctx.clip();
    // –ø–æ–¥–æ–≥–Ω–∞—Ç—å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω: —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    // –í—ã—á–∏—Å–ª–∏–º –º–∞—Å—à—Ç–∞–± –∏ —Å–º–µ—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–≤–∞–¥—Ä–∞—Ç avatarSize
    const ar = avatarImg.width / avatarImg.height;
    let dw = avatarSize, dh = avatarSize, sx = 0, sy = 0, sw = avatarImg.width, sh = avatarImg.height;
    if(ar > 1){
      // —à–∏—Ä–µ, —á–µ–º –≤—ã—Å–æ–∫–∏–π: –æ–±—Ä–µ–∑–∞–µ–º –ø–æ –±–æ–∫–∞–º
      sh = avatarImg.height;
      sw = avatarImg.height * ar;
      // center crop horizontally
      sx = (avatarImg.width - avatarImg.height * ar) / 2;
    } else if(ar < 1){
      // –≤—ã—à–µ, —á–µ–º —à–∏—Ä–æ–∫–∏–π: –æ–±—Ä–µ–∑–∞–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
      sw = avatarImg.width;
      sh = avatarImg.width / ar;
      sy = (avatarImg.height - avatarImg.width / ar) / 2;
    }
    // –ù–∞—Ç–∏–≤–Ω–∞—è drawImage —Å –æ–±—Ä–µ–∑–∫–æ–π (–ø—ã—Ç–∞—Ç—å—Å—è –∏–∑–±–µ–∂–∞—Ç—å –∏—Å–∫–∞–∂–µ–Ω–∏–π)
    // –ï—Å–ª–∏ crop –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, fallback –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π drawImage
    try {
      ctx.drawImage(avatarImg, sx, sy, sw, sh, avatarX, avatarY, avatarSize, avatarSize);
    } catch(e) {
      ctx.drawImage(avatarImg, avatarX, avatarY, avatarSize, avatarSize);
    }
    ctx.restore();
  } catch(e){
    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É:", e);
    // –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ ‚Äî —à–∞–±–ª–æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–ª—É—ç—Ç
  }

  // –¢–µ–∫—Å—Ç –∏–º–µ–Ω–∏
  ctx.fillStyle = "#111"; // —Ç—ë–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–≤–µ—Ä—Ö –ø–µ—Ä–≥–∞–º–µ–Ω—Ç–∞
  ctx.font = "bold 36px serif";
  ctx.textAlign = "center";
  // –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –ø—Ä–∏ –¥–ª–∏–Ω–Ω–æ–º –∏–º–µ–Ω–∏
  let displayName = name || "–ê–Ω–æ–Ω–∏–º";
  if(displayName.length > 18){
    ctx.font = "bold 28px serif";
  }
  ctx.fillText(displayName, canvas.width/2, 560);

  // –ù–∞–≥—Ä–∞–¥–∞ (–ø—Ä–∏–º–µ—Ä–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞)
  const reward = Math.max(10000, score * 10000); // –º–∏–Ω–∏–º—É–º 10k
  ctx.font = "bold 34px serif";
  ctx.fillText(reward.toLocaleString() + " Berries", canvas.width/2, 660);

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º canvas –∏ –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
  canvas.style.display = "block";
  const posterBtn = document.getElementById("posterBtn");
  posterBtn.style.display = "inline-block";
  posterBtn.onclick = () => {
    try {
      // –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      const link = document.createElement("a");
      link.download = `${displayName.replace(/\s+/g,'_')}_wanted.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
    } catch(err) {
      // –ï—Å–ª–∏ canvas "–∑–∞–ø—è—Ç–Ω–∞–Ω" (CORS), —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –ø–æ—Å—Ç–µ—Ä–∞:", err);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –ø–æ—Å—Ç–µ—Ä ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, –∞–≤–∞—Ç–∞—Ä–∫–∞ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑-–∑–∞ CORS.");
    }
  };
}

// ------------------- –°–¢–ê–†–¢ -------------------
loadQuestions();
loadLeaders();
</script>
</body>
</html>
